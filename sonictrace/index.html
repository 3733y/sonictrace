<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Interactive 3D Radio</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#101010; font-family:system-ui,sans-serif; }
    #hud{ position:fixed; left:10px; top:10px; max-width:70vw; z-index:15;
          background:rgba(0,0,0,.55); color:#aaffaa; padding:6px 10px; border-radius:6px; font:13px/1.5 system-ui; white-space:pre-wrap; }
    #nav{ position:fixed; right:12px; top:12px; display:flex; gap:8px; z-index:20; }
    #nav a{ background:#111; border:1px solid #444; color:#cfe9ff; padding:8px 10px; border-radius:8px; text-decoration:none; }
  </style>

  <!-- Tone.js -->
  <script src="./source/Tone.js"></script>
  <link rel="preload" as="audio" href="./source/likerainlikemusic.mp3">

  <!-- Import Map -->
  <script type="importmap">
  { "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  } }
  </script>
</head>
<body>
  <div id="nav"><a href="./sound.html" target="_blank">ÏÇ¨Ïö¥Îìú ÎπÑÏ£ºÏñº</a></div>
  <div id="hud">Î°úÎî© Ï§ë...</div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader }   from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader }  from 'three/addons/loaders/DRACOLoader.js';
    import { RGBELoader }   from 'three/addons/loaders/RGBELoader.js';

    const hud = document.getElementById('hud');
    const say = (m, ok=true)=>{ hud.textContent=m; hud.style.color = ok ? '#aaffaa' : '#ff7f7f'; };

    /* Renderer */
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace    = THREE.SRGBColorSpace;
    renderer.toneMapping         = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    renderer.shadowMap.enabled   = true;
    renderer.shadowMap.type      = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    /* Scene / Camera / Controls */
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.01, 5000);
    camera.position.set(0, 1.5, 3);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping   = true;
    controls.autoRotate      = true;
    controls.autoRotateSpeed = 0.5;
    controls.enablePan       = false;

    /* Lights */
    scene.add(new THREE.AmbientLight(0xffffff, 1.4));
    const keyLight = new THREE.DirectionalLight(0xffffff, 2.0);
    keyLight.position.set(5,5,5);
    keyLight.castShadow = true;
    keyLight.shadow.mapSize.set(2048,2048);
    keyLight.shadow.bias = -0.0001;
    scene.add(keyLight);

    /* HDR Environment ‚Äî fireplace */
    new RGBELoader().load(
      'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/fireplace_1k.hdr',
      (hdr)=>{
        hdr.mapping = THREE.EquirectangularReflectionMapping;
        scene.environment = hdr;
        scene.background  = hdr;
      }
    );

    /* Ïä§ÌîºÏª§ Î∞îÎã•(y)Îßå Í∏∞Ï§ÄÏúºÎ°ú Í≥ÑÏÇ∞ */
    function computeSupportY(root){
      const mins = [];
      root.traverse(o=>{
        if(!o.isMesh) return;
        const n = (o.name||'').toLowerCase();
        if(/wire|cable|cord|string|line/.test(n)) return;
        const b = new THREE.Box3().setFromObject(o);
        const sz = b.getSize(new THREE.Vector3());
        if (sz.x * sz.z < 1e-5) return;
        mins.push(b.min.y);
      });
      if(!mins.length) return new THREE.Box3().setFromObject(root).min.y;
      mins.sort((a,b)=>a-b);
      return mins[Math.floor(mins.length*0.2)];
    }

    /* Î™®Îç∏ Î°úÎìú */
    const loader = new GLTFLoader();
    const draco  = new DRACOLoader();
    draco.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');
    loader.setDRACOLoader(draco);

    const MODEL = './source/oldradio.glb';
    say('ÎùºÎîîÏò§ Î™®Îç∏ Î°úÎìú Ï§ë...');

    loader.load(MODEL, (gltf)=>{
      const model = gltf.scene;
      scene.add(model);
      model.traverse(o=>{ if(o.isMesh){ o.castShadow=true; o.receiveShadow=true; } });

      // ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
      model.updateMatrixWorld(true);
      let box = new THREE.Box3().setFromObject(model);
      const max = Math.max(...box.getSize(new THREE.Vector3()).toArray()) || 1;
      if(max < 0.2 || max > 20) model.scale.setScalar(2.0/max);

      // Ï±ÖÏÉÅ ÏÉùÏÑ±
      model.updateMatrixWorld(true);
      box = new THREE.Box3().setFromObject(model);
      const c = box.getCenter(new THREE.Vector3());
      const max2 = Math.max(...box.getSize(new THREE.Vector3()).toArray());
      const thick = max2*0.04;
      const tableW = max2*1.4, tableD = max2*1.0;

      const table = new THREE.Mesh(
        new THREE.BoxGeometry(tableW, thick, tableD),
        new THREE.MeshStandardMaterial({ color:0x765844, roughness:0.7 })
      );
      table.castShadow = true; table.receiveShadow = true;
      table.position.set(c.x, box.min.y - thick/2, c.z);
      scene.add(table);

      // Ïä§ÌîºÏª§ Î∞îÎã•ÏùÑ Ï±ÖÏÉÅÏóê Î∂ôÏûÑ
      model.updateMatrixWorld(true);
      const supportY = computeSupportY(model);
      const topY = table.position.y + thick/2;
      const diag = new THREE.Box3().setFromObject(model).getSize(new THREE.Vector3()).length();
      const sink = Math.max(diag*0.001, 0.001);
      model.position.y += (topY - supportY) - sink;

      // Ïπ¥Î©îÎùº Ï†ïÎ†¨
      model.updateMatrixWorld(true);
      const b2 = new THREE.Box3().setFromObject(model);
      const c2 = b2.getCenter(new THREE.Vector3());
      const s2 = b2.getSize(new THREE.Vector3());
      const m2 = Math.max(...s2.toArray());
      controls.target.set(c2.x, topY + m2*0.15, c2.z);
      const dist = m2 / (2 * Math.tan(THREE.MathUtils.degToRad(camera.fov * 0.5)));
      camera.position.set(c2.x, topY + m2*0.45, c2.z + dist*1.35);
      camera.near = Math.max(0.01, m2/100);
      camera.far  = Math.max(100, m2*20);
      camera.updateProjectionMatrix();

      // Î∞îÎã• Îß§Ìä∏ + Í∑∏Î¶ºÏûê Ï∫êÏ≤ò
      const padScale = 1.25;
      const floorMat = new THREE.Mesh(
        new THREE.PlaneGeometry(tableW*padScale, tableD*padScale),
        new THREE.MeshStandardMaterial({ color:0x141415, roughness:1.0 })
      );
      floorMat.rotation.x = -Math.PI/2;
      floorMat.position.set(c2.x, table.position.y - thick/2 - m2*0.01, c2.z);
      floorMat.receiveShadow = true;
      scene.add(floorMat);

      const shadowCatcher = new THREE.Mesh(
        new THREE.PlaneGeometry(tableW*padScale*1.1, tableD*padScale*1.1),
        new THREE.ShadowMaterial({ opacity:0.35 })
      );
      shadowCatcher.rotation.x = -Math.PI/2;
      shadowCatcher.position.copy(floorMat.position);
      shadowCatcher.position.y -= m2*0.001;
      shadowCatcher.receiveShadow = true;
      scene.add(shadowCatcher);

      say('Î™®Îç∏ + Ï±ÖÏÉÅ Ï†ïÎ†¨ ÏôÑÎ£å! ÌôîÎ©¥ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏùåÏïÖ Ïû¨ÏÉù üéµ');
    },
    (xhr)=>{ if(xhr.total) say(`Î™®Îç∏ Î°úÎî©‚Ä¶ ${Math.round((xhr.loaded/xhr.total)*100)}%`); },
    (err)=> say('‚ùå Î™®Îç∏ Î°úÎìú Ïã§Ìå®: '+(err?.message||err), false));

    /* Ïò§ÎîîÏò§ */
    const MUSIC_URL = new URL('./source/likerainlikemusic.mp3', location.href).href;
    let tonePlayer; const htmlAudio = new Audio(MUSIC_URL); htmlAudio.loop=true;
    let isPlaying=false;

    async function startMusic(){
      try{
        await Tone.start();
        if(!tonePlayer){ tonePlayer=new Tone.Player({url:MUSIC_URL,loop:true}).toDestination(); await Tone.loaded(); }
        tonePlayer.start(); isPlaying=true; say('üé∂ ÏùåÏïÖ Ïû¨ÏÉù Ï§ë (Îã§Ïãú ÌÅ¥Î¶≠ Ïãú Ï†ïÏßÄ)');
      }catch(e){
        try{ await htmlAudio.play(); isPlaying=true; say('üéß HTMLAudio Ïû¨ÏÉù Ï§ë (Îã§Ïãú ÌÅ¥Î¶≠ Ïãú Ï†ïÏßÄ)'); }
        catch(e2){ say('ÏùåÏïÖ Ïû¨ÏÉù Ïã§Ìå®: '+(e2?.message||e2), false); }
      }
    }
    function stopMusic(){ if(tonePlayer) tonePlayer.stop(); if(!htmlAudio.paused) htmlAudio.pause(); isPlaying=false; say('‚èπ Ï†ïÏßÄÎê® (ÌÅ¥Î¶≠ Ïãú Ïû¨ÏÉù)'); }
    addEventListener('pointerdown', async()=>{ if(!isPlaying) await startMusic(); else stopMusic(); }, {passive:true});

    addEventListener('resize', ()=>{ renderer.setSize(innerWidth, innerHeight); camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); });
    (function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); })();
  </script>
</body>
</html>
