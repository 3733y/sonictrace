<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Sound Reactive Visual</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{margin:0;height:100%;background:#0d0f12;overflow:hidden}
    #ui{position:fixed;left:12px;top:12px;display:flex;gap:8px;z-index:10}
    button{background:#111;border:1px solid #444;color:#cfe9ff;padding:8px 10px;border-radius:8px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    #hint{position:fixed;left:12px;bottom:12px;color:#9aa7b8;font:12px/1.4 system-ui}
  </style>

  <!-- p5.js + p5.sound (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/addons/p5.sound.min.js"></script>

  <!-- (ì„ íƒ) ê¸°ì¡´ ìŒì•… ì¬ìƒìš©: Tone ì—†ì´ HTMLAudioë¡œ -->
  <link rel="preload" as="audio" href="./source/likerainlikemusic.mp3">
</head>
<body>
  <div id="ui">
    <button id="micBtn">ğŸ™ï¸ ë§ˆì´í¬ ì‹œì‘</button>
    <button id="trackBtn">ğŸµ íŠ¸ë™ ì¬ìƒ</button>
    <button id="stopBtn" disabled>â¹ ì •ì§€</button>
  </div>
  <div id="hint">Tip: ë§ˆì´í¬ëŠ” HTTPSë‚˜ ë¡œì»¬(127.0.0.1)ì—ì„œë§Œ ê¶Œí•œì´ ì—´ë¦½ë‹ˆë‹¤.</div>

  <script>
    // ìƒíƒœ ë³€ìˆ˜
    let mic, fft, audio;
    let usingMic = false, usingTrack = false;

    // p5 ìŠ¤ì¼€ì¹˜
    function setup(){
      createCanvas(window.innerWidth, window.innerHeight);
      noStroke();
      colorMode(HSB, 360, 100, 100, 100);
      fft = new p5.FFT(0.8, 64); // ìŠ¤ë¬´ë”©, ë¹ˆ ìˆ˜
    }

    function windowResized(){
      resizeCanvas(window.innerWidth, window.innerHeight);
    }

    function draw(){
      background(218, 30, 8); // ì–´ë‘ìš´ ë‚¨ì²­ìƒ‰

      // ìŠ¤í™íŠ¸ëŸ¼ ê°€ì ¸ì˜¤ê¸°
      const spectrum = fft.analyze();

      // ë§‰ëŒ€ ê·¸ë˜í”„
      const n = spectrum.length;
      const w = width / n;
      for (let i=0; i<n; i++){
        const amp = spectrum[i];               // 0~255
        const h = map(amp, 0, 255, 0, height); // ë†’ì´
        const hue = map(i, 0, n-1, 190, 340);  // ì²­ë¡â†’ë³´ë¼
        fill(hue, 80, map(amp, 0,255, 30, 95), 95);
        rect(i*w, height-h, w*0.9, h, 4);
      }

      // ì›í˜• ë°˜ì‘ íŒŒíŠ¸ (ì„¼í„° ì˜¤ë¸Œì íŠ¸)
      const level = fft.getEnergy('bass','lowMid','mid')/255; // 0~1
      push();
      translate(width/2, height/2);
      const r = map(level, 0, 1, min(width,height)*0.06, min(width,height)*0.18);
      fill(210, 60, 95, 85);
      circle(0,0,r*2);
      pop();
    }

    // ì…ë ¥ ì†ŒìŠ¤ ì„¸íŒ…
    async function startMic(){
      if (usingMic) return;
      // p5 ë§ˆì´í¬
      mic = new p5.AudioIn();
      await mic.start();        // ê¶Œí•œ ìš”ì²­ (ì‚¬ìš©ì ì œìŠ¤ì²˜ ì´í›„)
      fft.setInput(mic);
      usingMic = true; usingTrack = false;
      if (audio) { audio.pause(); }
      updateButtons();
    }

    function startTrack(){
      if (usingTrack) return;
      if (!audio){
        audio = new Audio(new URL('./source/likerainlikemusic.mp3', location.href));
        audio.loop = true;
        audio.crossOrigin = 'anonymous';
        // p5.soundë¡œ ë¶„ì„í•˜ë ¤ë©´ MediaElementë¥¼ FFTì— ì—°ê²°
        const media = new p5.MediaElement(audio);
        fft.setInput(media);
      }
      audio.play();
      usingTrack = true; usingMic = false;
      updateButtons();
    }

    function stopAll(){
      if (mic) mic.stop();
      if (audio) audio.pause();
      usingMic = usingTrack = false;
      updateButtons();
    }

    function updateButtons(){
      document.getElementById('stopBtn').disabled = !(usingMic || usingTrack);
    }

    // ë²„íŠ¼ í•¸ë“¤ëŸ¬
    document.getElementById('micBtn').addEventListener('click', startMic);
    document.getElementById('trackBtn').addEventListener('click', startTrack);
    document.getElementById('stopBtn').addEventListener('click', stopAll);
  </script>
</body>
</html>
